# Flutter Project Development Guide

## Project Overview

- **Project Name**: noexc
- **Framework**: Flutter
- **Language**: Dart
- **SDK Version**: ^3.7.2 (Compatible with Flutter 3.29.3)
- **Type**: Cross-platform mobile/desktop/web application with React Flow authoring tool
- **Status**: Fully functional accountability/habit-tracking chat application with comprehensive features, modular architecture, sequence-based conversation system, visual authoring tool, and advanced task management with deadline tracking
- **Current Development Focus**: Task deadline management, automatic status updates, and enhanced session tracking

## Project Structure

### Core Directories
- `lib/` - Main Dart source code
  - `main.dart` - Application entry point with session management and theme persistence
  - `models/` - Data models (ChatMessage, Choice, ChatSequence, DataAction, RouteCondition)
  - `services/` - Business logic services (ChatService, UserDataService, TextTemplatingService, SessionService, TextVariantsService, DataActionProcessor, ErrorHandler, MessageQueue)
  - `constants/` - Centralized constants (AppConstants, UIConstants, ThemeConstants)
  - `config/` - Configuration files (ChatConfig)
  - `themes/` - Theme configuration (AppThemes)
  - `validation/` - Asset and sequence validation (AssetValidator, SequenceValidator)
  - `widgets/` - UI components
    - `chat_screen/` - Modular chat components (8 focused components)
    - `user_variables_panel.dart` - Comprehensive debug panel with chat controls
    - `sequence_selector.dart` - Sequence selection widget
- `test/` - Widget and unit tests with comprehensive TDD coverage (30+ test files)
  - `widget_test.dart` - Main app widget tests
  - `models/` - Unit tests for data models (5 test files)
  - `services/` - Unit tests for service layer (16 test files including task management, deadline tracking, and automatic status updates)
  - `validation/` - Validation system tests (3 test files)
  - `widgets/` - Widget tests for UI components (4 test files including debug panel components)
- `assets/` - Static assets including chat sequences and text variants
  - `chat_script.json` - Legacy chat script (for backward compatibility)
  - `sequences/` - Modular chat sequences (10 sequences: welcome, onboarding, task checking/setting, success/failure, sendoff, task configuration, day tracking test)
  - `variants/` - Text variant files for dynamic message content
- `noexc-authoring-tool/` - React Flow visual authoring tool for conversation sequences
  - React-based drag-and-drop interface for creating conversation flows
  - Visual node editor with variable management and flow validation
  - Export functionality to generate JSON sequences for Flutter app

### Platform-Specific Directories
- `android/` - Android-specific configuration and native code
- `ios/` - iOS-specific configuration and native code  
- `web/` - Web-specific configuration and assets
- `windows/` - Windows desktop configuration
- `linux/` - Linux desktop configuration
- `macos/` - macOS desktop configuration

### Configuration Files
- `pubspec.yaml` - Package dependencies and Flutter configuration
- `analysis_options.yaml` - Dart analyzer and linting rules
- `.gitignore` - Git ignore patterns for Flutter projects

### Dependencies

#### Main Dependencies
- `flutter` - Flutter SDK
- `cupertino_icons: ^1.0.8` - iOS-style icons
- `shared_preferences: ^2.2.2` - Local data storage for user information recall

#### Development Dependencies
- `flutter_test` - Testing framework
- `flutter_lints: ^5.0.0` - Recommended linting rules

## Development Guidelines

### Code Style and Linting
- Uses `package:flutter_lints/flutter.yaml` for recommended linting rules
- Follow Flutter/Dart naming conventions
- Use `super.key` for widget constructors
- Prefer `const` constructors where possible

### Testing (Test-Driven Development Required)
- **ALWAYS use Test-Driven Development (TDD)** for this project
- Write tests BEFORE implementing functionality (Red-Green-Refactor cycle)
- Follow TDD workflow:
  1. **Red**: Write a failing test that describes the desired behavior
  2. **Green**: Write the minimum code to make the test pass
  3. **Refactor**: Improve the code while keeping tests green
- **Comprehensive test coverage implemented**: 22 test files covering all major functionality
- Use `flutter test` to run tests
- Test files mirror the `lib/` directory structure in `test/`
- Import main app code using `package:noexc/main.dart`
- **Current test status: 293 tests passing, 7 failing** (Mostly due to sequence content changes)
- Failing tests are primarily outdated expectations from sequence updates, not functional issues
- Aim for high test coverage (minimum 80%) - Currently maintaining excellent coverage
- Never commit code without corresponding tests

### Project Commands
- `flutter run` - Run the application
- `flutter test` - Run all tests
- `flutter analyze` - Run static analysis
- `flutter pub get` - Install dependencies
- `flutter pub upgrade` - Update dependencies
- `flutter clean` - Clean build artifacts

### File Organization
- Keep main application logic in `lib/`
- **Constants organized by purpose**: `lib/constants/` and `lib/config/`
- **Modular widget structure**: `lib/widgets/chat_screen/` for chat components
- Use descriptive file and class names
- Follow Flutter's widget composition patterns
- **Single Responsibility Principle**: Each file has one clear purpose
- Separate concerns into focused, maintainable components

### Platform Support
This project is configured for:
- Android
- iOS  
- Web
- Windows
- Linux
- macOS

### Best Practices
- Use `setState()` for local state management
- Implement proper widget lifecycle methods
- Use Material Design components for consistent UI
- Follow Flutter's reactive programming model
- Write tests for critical functionality
- Use hot reload for faster development iteration

### Documentation Maintenance
- **ALWAYS update this .agent.md file after significant changes**
- Update documentation when:
  - Adding new dependencies or packages
  - Changing project structure or architecture
  - Implementing new development patterns or practices
  - Adding new build scripts or development tools
  - Modifying testing strategies or requirements
  - Adding new platform support or configurations
  - Establishing new coding conventions or guidelines
- Keep the documentation current and accurate for new team members
- Document any project-specific patterns, utilities, or conventions
- Include examples and rationale for important decisions

### Current Application
The app is an **accountability and habit-tracking chat application** with a conversational AI companion named "Tristopher" (Trist) that helps users:

#### Core Functionality
- **Daily Task Management** - Set, track, and complete daily accountability tasks
- **Habit Tracking** - Monitor streaks, visit counts, and progress over time
- **Conversational AI Companion** - Interactive chat with personality-driven responses
- **Session Management** - Automatic tracking of visits, time of day, and user patterns
- **Onboarding Flow** - Welcome new users and collect essential information

#### Technical Features
- **Interactive chat interface** with bot and user messages
- **Sequence-based conversation system** with 7 modular chat flows (welcome, onboarding, task checking/setting, success/failure, sendoff)
- **Choice-based navigation** allowing users to select conversation paths
- **Cross-sequence navigation** enabling seamless flow between different conversation topics
- **Autoroute System** - conditional routing based on user attributes with invisible processing
- **Data Action System** - increment/decrement counters, set values, trigger events
- **Text input functionality** for user responses and personalization
- **Multi-text Messages** - separator-based message splitting (|||) for dramatic effect
- **Text Variants System** - dynamic message content with randomized alternatives
- **User Information Recall System** with local data persistence and session tracking
- **Text templating with fallback values** for personalized messaging
- **Message Queue System** - prevents race conditions and handles message delays
- **Error Handling** - comprehensive error management with custom exceptions
- **Asset Validation** - sequence and file integrity validation
- **Comprehensive Debug Panel** - sliding overlay with developer tools and controls
- **Chat State Management** - Reset, Clear, Reload controls for rapid development iteration
- **User Data Management** - Clear All Data functionality with confirmation for clean testing
- **Sequence Selection** - Integrated dropdown in debug panel for easy sequence switching
- **Modular component architecture** - divided ChatScreen widget
- **Centralized constants and configuration** for better maintainability
- **React Flow Authoring Tool** - visual editor for creating conversation sequences
- Chat sequences loaded from JSON asset files (`assets/sequences/`)
- Material Design theming with purple color scheme and dark/light mode support
- Advanced state management with ChangeNotifier pattern
- Clean chat message bubbles with sender differentiation
- Simulated typing delays between messages
- Loading indicator while chat sequences load
- Comprehensive test coverage following TDD principles (22 test files, all passing)

### Architecture
- **Models**: 
  - `ChatMessage` class for message data structure with sender, choices, text input support, storeKey for data persistence, autoroute fields, and data actions
  - `Choice` class for representing user choice options with cross-sequence navigation support and custom value storage
  - `ChatSequence` class for managing modular conversation flows with metadata
  - `RouteCondition` class for defining conditional routing logic with conditions, sequence targets, and fallback options
  - `DataAction` class for defining data manipulation operations (set, increment, decrement, reset, trigger)
- **Services**: 
  - `ChatService` for loading chat sequences, managing conversation flow, cross-sequence navigation, autoroute processing, and handling user interactions
  - `UserDataService` for local data storage and retrieval using shared_preferences
  - `TextTemplatingService` for dynamic text substitution with fallback support
  - `ConditionEvaluator` for evaluating user attribute-based routing conditions with support for ==, !=, >, <, >=, <=, and boolean checks
  - `SessionService` for automatic session tracking, visit counts, time of day, and date management
  - `TextVariantsService` for loading and managing randomized text alternatives from asset files
  - `DataActionProcessor` for processing data manipulation actions with event callbacks
  - `ChatErrorHandler` for comprehensive error handling with custom exception types
  - `MessageQueue` for managing message display timing and preventing race conditions
- **Constants & Configuration**:
  - `AppConstants` - Application-wide constants (titles, storage keys, delays, available sequences)
  - `UIConstants` - UI styling constants (spacing, animations, sizes)
  - `ChatConfig` - Chat functionality configuration
  - `ThemeConstants` - Theme and color constants
- **Validation**:
  - `AssetValidator` - Validates sequence files and asset integrity
  - `SequenceValidator` - Validates sequence structure and message flow logic
- **Widgets**: 
  - `ChatScreen` - Main orchestrator with session management
  - `ChatStateManager` - Centralized state management with ChangeNotifier and debug controls
  - `MessageBubble` - Individual message display routing
  - `ChoiceButtons` - Choice selection UI component
  - `TextInputBubble` - Text input interface component
  - `ChatMessageList` - Message list management
  - `ChatAppBar` - App bar with theme toggle and debug panel access
  - `UserPanelOverlay` - Panel overlay management
  - `UserVariablesPanel` - Comprehensive debug panel with chat controls, sequence selection, and user data display
  - `SequenceSelector` - Standalone sequence selection widget
- **Assets**: 
  - **Legacy**: `chat_script.json` for backward compatibility
  - **Sequences**: 7 modular JSON files in `assets/sequences/` containing:
    - `welcome_seq.json` - Entry point with onboarding routing
    - `onboarding_seq.json` - New user welcome and setup with personality introduction
    - `taskSetting_seq.json` - Daily task creation and configuration
    - `taskChecking_seq.json` - Task completion verification and routing
    - `success_seq.json` - Celebration and streak tracking for completed tasks
    - `failure_seq.json` - Handling task failures with streak resets and second chances
    - `sendoff_seq.json` - Daily session conclusion
  - **Text Variants**: Dynamic message alternatives in `assets/variants/` for randomized content
  - Each sequence supports branching conversations, choices, text input, cross-sequence navigation, autoroute conditions, data actions, multi-text messages, and storage keys

### Chat Sequence Structure
```json
{
  "sequenceId": "onboarding_seq",
  "name": "User Onboarding",
  "description": "Welcome new users and collect basic information",
  "messages": [
    {
      "id": 1,
      "text": "Hello, {user.name|Guest}! Welcome to the app!",
      "delay": 1000,
      "sender": "bot",
      "type": "choice",
      "storeKey": "user.name",
      "choices": [
        {"text": "Option 1", "nextMessageId": 10},
        {"text": "Go to Support", "sequenceId": "support", "nextMessageId": 1}
      ],
      "nextMessageId": 2,
      "dataActions": [
        {"type": "set", "key": "user.isOnboarded", "value": true}
      ]
    }
  ]
}
```

### React Flow Authoring Tool

Located in `noexc-authoring-tool/`, this is a **visual authoring tool** for creating conversation sequences:

#### Purpose
- **Visual Flow Creation**: Drag-and-drop interface for building conversation flows
- **Node-Based Editing**: Different node types for messages, choices, inputs, and routing
- **Variable Management**: Built-in variable manager for user data tracking
- **Export to Flutter**: Direct export to JSON format compatible with Flutter app
- **Flow Validation**: Real-time validation of conversation logic and structure

#### Key Features
- **Multiple Node Types**: Message, Choice, Text Input, Autoroute, Data Action nodes
- **Visual Connections**: Drag connections between nodes to define conversation flow
- **Variable Integration**: Visual variable picker and template insertion
- **Group Management**: Organize related nodes into collapsible groups
- **Export System**: Generate Flutter-compatible JSON sequences
- **Help System**: Contextual tooltips and documentation

#### Usage
1. **Start Development Server**: `cd noexc-authoring-tool && npm start`
2. **Create Flows**: Drag nodes from palette and connect them
3. **Configure Nodes**: Set text, choices, conditions, and data actions
4. **Manage Variables**: Use variable manager for user data tracking
5. **Export Sequences**: Generate JSON files for Flutter app
6. **Import to Flutter**: Copy exported JSON to `assets/sequences/`

### New Features (Latest Updates)

#### Advanced Task Management System (2025 Updates)
- **Task Boolean Computation**: Automatic computation of `isActiveDay` and `isPastDeadline` flags
- **Deadline Tracking**: Comprehensive deadline management with time-based status updates
- **Automatic Status Updates**: Enhanced automatic status updates with logging for task deadlines
- **Grace Period Handling**: Previous day task completion grace periods with archiving
- **Date-Time Picker**: DateTimePickerWidget for selecting task dates and deadline times
- **Status Preservation**: Maintains task status across sessions without morning recovery logic

#### Session Management System
- **Automatic Session Tracking**: Visit counts, time of day, date information
- **Daily Reset Logic**: Visit counters reset each day while maintaining total counts
- **Time-Based Variables**: Morning/afternoon/evening/night detection
- **Date Calculations**: Days since first visit, weekend detection
- **Task Archiving**: Automatic archiving of previous day tasks when moving to new day
- **Persistent Storage**: All session data stored locally with SharedPreferences

#### Text Variants System
- **Dynamic Content**: Randomized message alternatives for variety
- **Asset-Based Storage**: Variants stored in separate `.txt` files in `assets/variants/`
- **Caching System**: Efficient loading and caching of variant files
- **Fallback Support**: Graceful handling when variant files don't exist
- **Naming Convention**: `{sequenceId}_message_{messageId}.txt` format

#### Data Action System
- **Action Types**: Set, increment, decrement, reset, trigger operations
- **Event Callbacks**: Trigger custom events with data payloads
- **Batch Processing**: Process multiple actions in sequence
- **Type Safety**: Support for different data types (string, int, bool, etc.)
- **UI Integration**: Actions can trigger UI notifications and updates

#### Enhanced Error Handling
- **Custom Exception Types**: Specific error types for different failure scenarios
- **Graceful Degradation**: App continues functioning even with asset errors
- **Detailed Logging**: Comprehensive error information for debugging
- **User-Friendly Messages**: Clean error presentation to end users
- **Recovery Mechanisms**: Automatic fallback to default sequences when needed

#### Message Queue System
- **Race Condition Prevention**: Ensures messages display in correct order
- **Delay Management**: Handles message timing and delays properly
- **Batch Processing**: Efficient processing of multiple messages
- **Resource Cleanup**: Proper timer disposal to prevent memory leaks
- **Thread Safety**: Safe concurrent access to message queue

#### Asset Validation System
- **Sequence Validation**: Comprehensive validation of sequence structure
- **Reference Checking**: Validates all message and sequence references
- **Error Reporting**: Detailed validation reports with specific error locations
- **Performance Testing**: Validation timing and performance metrics
- **Development Tools**: CLI tools for batch validation of all sequences

#### Multi-Text Message Support
- **Separator-Based Splitting**: Use `|||` to split messages into multiple parts
- **Dramatic Effect**: Creates conversation pauses and emphasis
- **Flexible Timing**: Each part can have individual delays
- **Template Support**: Text templating works within each message part
- **Variant Compatibility**: Works seamlessly with text variants system

### Interactive Features
- **Choice Selection**: Users can tap buttons to select conversation paths
- **Cross-Sequence Navigation**: Seamless switching between different conversation topics
- **Autoroute Conditions**: Invisible conditional routing based on user attributes and stored data
- **Custom Value Storage**: Choices can store clean custom values separate from display text
- **Text Input**: Users can type responses for personalization
- **Branching Conversations**: Different paths based on user choices within and across sequences
- **Intelligent Routing**: Automatic sequence switching based on user profile, task status, streak count, etc.
- **Data Actions**: Automatic data manipulation (counters, flags, values) based on user interactions
- **Multi-Text Messages**: Dramatic message delivery with separator-based splitting
- **Text Variants**: Randomized message content for variety and engagement
- **Session Tracking**: Automatic visit counting and time-based personalization
- **Enhanced Message Display**: Questions and prompts shown alongside interactive elements for better context
- **Sequence Management**: Service manages multiple conversation flows and state transitions
- **Message Flow Control**: Advanced conversation state and progression management
- **User Response Handling**: Creates user messages and continues conversation flow
- **Data Persistence**: User inputs and choices are automatically stored locally across sequences
- **Text Templating**: Messages are personalized using stored user data
- **Fallback Values**: Professional messaging with `{key|fallback}` syntax prevents raw placeholders
- **Debug Panel**: Comprehensive developer tools accessible via bug report icon in AppBar
- **Chat State Controls**: Reset, Clear Messages, and Reload Sequence for rapid development
- **User Data Management**: Clear All Data with confirmation dialog for clean testing scenarios
- **Sequence Selection**: Dropdown selector in debug panel for easy sequence switching
- **Modular Conversations**: Organized conversation flows for accountability, task management, and habit tracking

### Getting Started
1. Ensure Flutter SDK is installed and configured
2. Run `flutter pub get` to install dependencies
3. Use `flutter test` to verify tests (293 passing, 7 failing due to sequence content updates)
4. Use `flutter run` to start the accountability chat application
5. Explore the sequence-based chat interface with Tristopher (Trist)
6. Test the habit tracking by setting a daily task and checking completion
7. Navigate between different conversation sequences (welcome, onboarding, task management)
8. Access the Debug Panel by tapping the bug report icon in the AppBar for developer tools
9. Use chat state controls (Reset, Clear, Reload) for rapid development iteration
10. Test user data management with Clear All Data for clean testing scenarios
11. Switch sequences using the dropdown in the debug panel (10 available sequences)
12. **Test session management**: Notice visit counts and time-based greetings
13. **Test text variants**: Observe randomized message content on repeated interactions
14. **Test data actions**: Watch counters and flags update based on user choices
15. **Test task management**: Set deadlines, observe automatic status updates, test grace periods
16. **Test deadline tracking**: Use DateTimePickerWidget to set task deadlines and observe `isPastDeadline` computation
17. **Enhanced UX**: Notice questions displayed with choice buttons and text input fields
18. Begin development by following TDD principles and updating relevant models, services, or widgets
19. **Sequence system**: Add new conversation flows by creating JSON files in `assets/sequences/`
20. **Modular architecture**: Components are organized in `lib/widgets/chat_screen/` for easy maintenance
21. **Visual authoring**: Use React Flow tool in `noexc-authoring-tool/` for creating sequences
22. **Asset validation**: Run validation tools to ensure sequence integrity

### Notes
- This is a private package (`publish_to: 'none'`)
- Uses Material Design by default
- Hot reload is supported for faster development
- All platforms are pre-configured and ready for development
- Current Flutter version: 3.29.3 (stable channel)
- **Comprehensive test suite** - 30+ test files with 293 passing tests (7 failing due to sequence updates)
- **Architecture ready for scaling** - Modular design supports future growth
- **Cross-sequence navigation** - Seamless conversation flow management
- **Advanced task management** - Deadline tracking, automatic status updates, grace periods
- **Accountability focus** - App designed specifically for habit tracking and task completion
- **Visual authoring tool** - React Flow interface for non-technical sequence creation
- **Production ready** - Comprehensive error handling, validation, and testing
- **Recent focus**: Task deadline management, boolean computation, and enhanced session tracking